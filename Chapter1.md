# 카프카란?
간단하게 표현하면, 카프카는 메세지 `중개자` 또는 `브로커` 이다.</br>
```
여기서 메세지란, 특정 작업을 수행하도록 하는 요청이라고 보면 될 것 같다.
```
# 카프카 사용 이유
## 카프카 도입 이전 아키텍처
![alt text](image.png)
## 카프카 도입 이후 아키텍처
![alt text](image-1.png)
# 카프카 기본 개념
## 메세지
![alt text](image-4.png)
* Headers : 지정된 토픽
* Key : 토픽 내부의 파티션 지정 
* Value : 실제 보내고자 하는 데이터

### 🚀 메세지는 파티션에 저장 될 때, 배치 단위로 저장된다❗
이를 통해 한 번 보낼 때, 다량의 메세지를 보내 네트워크에서 발생하는 오버헤드를 줄일 수 있다.</br>
**물론 다량의 메세지를 처리하기 위해 발생하는 Latency 고려 필요(트레이드오프)**

## 스키마
* 메세지 스키마
  * JSON
  * XML
  * Avro

메세지 스키마에는 대표적으로 3가지가 있는데 가장 대중적인 JSON과 XML을 사용할 때 몇 가지 단점이 있다.

### JSON과 XML 단점
* JSON과 XML은 텍스트 기반 데이터 포맷으로 **데이터 타입을 명시적으로 지원하는 구조가 아니다.**
때문에 다양한 데이터 타입을 처리하는데 불리하다.
* 타입을 명시하지 않기 때문에 프로듀서와 컨슈머간 메시지 **스키마 변경에 따른 호환성이 떨어진다.**

![alt text](image-5.png)

## 토픽과 파티션
토픽은 데이터베이스의 `테이블`이라고 생각하면 되며, 파티션은 말 그대로 토픽을 쪼개놓은 것 이다.
![alt text](image-6.png)

### 파티션을 사용하는 이유
파티션을 사용하면 컨슈머가 메세지를 순차적으로 처리할 수 없다는데 굳이 파티션을 나누는 이유가 뭘까 생각할 수 있다.</br>
만약 하나의 파티션을 사용한다면, 대량의 메세지를 발행했을 때 또는 메세지 컨슘 시, 순차적으로 파티션에 추가 또는 읽기 작업을 진행한다.</br>
이는 단일 서버를 사용할 때와 마찬가지로 `처리 능력이 떨어진다`는 단점이 존재한다.</br></br>
이러한 문제점을 해결하기 위해 파티션을 나누어 병렬적 처리 한다.

## 프로듀서와 컨슈머
![alt text](image-7.png)
이름과 같이 의미가 아주 직관적이다. 프로듀서는 메세지 생성자(발행자), 컨슈머는 메세지 구독자라는 것을 쉽게 파악할 수 있다.

### 컨슈머의 오프셋
만약 메세지를 구독하는 컨슈머가 메세지를 어디까지 처리했는지 알 수 없다면 어떨까?</br>
책을 읽을 때, 책갈피로 읽었던 부분을 표시하지 않으면 처음부터(?) 다시 읽어야 하는 것과 같은 맥락이다.</br>
(카프카 정책 상 메세지 처리에 성공하여도 메세지를 삭제하지 않기 때문에 오프셋이 필요하다.)</br></br>

🚀 카프카는 하나의 파티션이 하나의 컨슈머에 의해서 소비되는 것을 보장한다.

### 컨슈머의 수평적 확장
하나의 파티션을 컨슈머 그룹 내 하나의 컨슈머가 처리하도록 보장(N:1 관계라 생각하면 이해하기 쉬울 것 같다..)해주기 때문에 수평적 확장이 가능하며</br>
컨슈머에 장애가 발생해도 그룹 내 다른 컨슈머가 해당 파티션에 대한 소유권을 넘겨 받아 처리한다.

## 브로커와 클러스터
### 컨트롤러 브로커
카프카 서버(브로커)는 클러스터로 동작하도록 설계가 되었다. 때문에 여러 브로커들을 관리하고 모니터링하는 역할의 컨트롤러 브로커를 둔다.
![alt text](image-8.png)

### 파티션 리더
파티션은 여러 브로커에 복제하여 사용할 수 있기 때문에 파티션 리더를 하나 두고 이를 복제하는 팔로우들로 구성된다.</br>
DB 클러스터에서 Writer DB와 Reader DB를 구분한 것 처럼 생각하면 될 것 같다.</br>
때문에 프로듀서들은 메세지를 발행할 때, 무조건 파티션 리더에 발행해야한다. 그에 반해 컨슈머들은 리더, 팔로우 상관없이 아무곳에서 메세지를 읽을 수 있다.
![alt text](image-9.png)

# 질문
## 메세지를 배치 단위로 저장할 때, 마지막 메세지가 걸린다면?
## 메세지에 Key가 필요한 이유
## 토픽의 파티션과 컨슈머가 1:1 대응인 이유
